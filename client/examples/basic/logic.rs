use super::{renderer::MainRenderer, vertex::VertexBasic};

use rustgame::{input::InputState, logic::GameLogic, object::Object};

use cgmath::{InnerSpace, Matrix4, Point3, Vector3};

use winit::event::WindowEvent;

/*--------------------------------------------------------------------------------------------------*/

fn create_vertices() -> (Vec<VertexBasic>, Vec<u16>) {
    let vertex_data = [
        // Back face
        [-1.0, -1.0, 1.0, 0.0, 0.0, 1.0],
        [1.0, -1.0, 1.0, 0.0, 0.0, 1.0],
        [1.0, 1.0, 1.0, 0.0, 0.0, 1.0],
        [-1.0, 1.0, 1.0, 0.0, 0.0, 1.0],
        // Front face
        [-1.0, -1.0, -1.0, 0.0, 0.0, -1.0],
        [-1.0, 1.0, -1.0, 0.0, 0.0, -1.0],
        [1.0, 1.0, -1.0, 0.0, 0.0, -1.0],
        [1.0, -1.0, -1.0, 0.0, 0.0, -1.0],
        // Bottom face
        [-1.0, 1.0, -1.0, 0.0, 1.0, 0.0],
        [-1.0, 1.0, 1.0, 0.0, 1.0, 0.0],
        [1.0, 1.0, 1.0, 0.0, 1.0, 0.0],
        [1.0, 1.0, -1.0, 0.0, 1.0, 0.0],
        // Top face
        [-1.0, -1.0, -1.0, 0.0, -1.0, 0.0],
        [1.0, -1.0, -1.0, 0.0, -1.0, 0.0],
        [1.0, -1.0, 1.0, 0.0, -1.0, 0.0],
        [-1.0, -1.0, 1.0, 0.0, -1.0, 0.0],
        // Right face
        [1.0, -1.0, -1.0, 1.0, 0.0, 0.0],
        [1.0, 1.0, -1.0, 1.0, 0.0, 0.0],
        [1.0, 1.0, 1.0, 1.0, 0.0, 0.0],
        [1.0, -1.0, 1.0, 1.0, 0.0, 0.0],
        // Left face
        [-1.0, -1.0, -1.0, -1.0, 0.0, 0.0],
        [-1.0, -1.0, 1.0, -1.0, 0.0, 0.0],
        [-1.0, 1.0, 1.0, -1.0, 0.0, 0.0],
        [-1.0, 1.0, -1.0, -1.0, 0.0, 0.0],
    ]
    .iter()
    .map(|raw_vertex| {
        VertexBasic::new(
            cgmath::Point3 {
                x: raw_vertex[0],
                y: raw_vertex[1],
                z: raw_vertex[2],
            },
            cgmath::Vector3 {
                x: raw_vertex[3],
                y: raw_vertex[4],
                z: raw_vertex[5],
            },
        )
    })
    .collect::<Vec<VertexBasic>>();
    let index_data = [
        0, 1, 3, 3, 1, 2, 4, 5, 6, 6, 7, 4, 8, 9, 10, 10, 11, 8, 12, 13, 14, 14, 15, 12, 16, 17,
        18, 18, 19, 16, 20, 21, 22, 22, 23, 20,
    ]
    .to_vec();

    return (vertex_data, index_data);
}

/*--------------------------------------------------------------------------------------------------*/

pub struct MainLogic {
    input_state: InputState,

    objects: Vec<Object>,
    controllers: Vec<Box<dyn Fn(&mut Object)>>,
}

impl GameLogic<MainRenderer> for MainLogic {
    fn new() -> Self {
        Self {
            input_state: InputState::new(),

            objects: Vec::new(),
            controllers: Vec::new(),
        }
    }

    fn setup(&mut self, renderer: &mut MainRenderer) {}

    fn step(&mut self) {
        self.controllers
            .iter()
            .zip(self.objects.iter_mut())
            .for_each(|(controller, object)| {
                controller(object);
                object.apply_changes();
            });
    }

    fn handle_input(&mut self, event: &WindowEvent) {
        self.input_state.handle(event);
    }
}
